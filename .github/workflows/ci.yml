name: CI

on:
  push:
  pull_request:

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      CARGO_TARGET_DIR: target
      CARGO_PROFILE_DEV_DEBUG: 0
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: 1.89.0
          components: rustfmt,clippy
          targets: wasm32-wasip2
      - name: Install ripgrep
        run: sudo apt-get update && sudo apt-get install -y ripgrep
      - name: Install WIT tooling
        run: cargo install wasm-tools --locked
      - name: Check for duplicate canonical WIT
        run: bash ci/check_no_duplicate_canonical_wit.sh .
      - name: Show toolchain versions
        run: |
          wasm-tools --version
          cargo --version
          rustc --version
      - name: Install wasm32-wasip2 target
        run: rustup target add wasm32-wasip2
      - run: cargo fmt --all -- --check
      - run: cargo clippy --workspace --all-features -- -D warnings
      - name: Validate ABI WIT packages
        run: bash scripts/validate-wit.sh crates/greentic-interfaces/wit
      - name: Ensure SPDX headers present
        run: |
          set -euo pipefail
          missing=$(rg --files -g 'package.wit' crates/greentic-interfaces/wit | while read -r file; do
            if [[ "$(head -n1 "$file")" != "// SPDX-License-Identifier: MIT" ]]; then
              echo "$file"
            fi
          done)
          if [[ -n "${missing}" ]]; then
            echo "::error::Missing SPDX header in the following WIT files:"
            echo "${missing}"
            exit 1
          fi
      - name: Guard WIT API against latest tag
        run: |
          set -euo pipefail
          latest_tag="$(git tag --list 'v*' --sort=-version:refname | head -n1 | tr -d '\n')"
          baseline_tag="${BASELINE_TAG:-${latest_tag}}"
          if [[ -z "${baseline_tag}" ]]; then
            echo "No baseline release tag found; skipping WIT diff."
            exit 0
          fi
          baseline_version="${baseline_tag#v}"
          current_version="$(grep -m1 '^version = ' crates/greentic-interfaces/Cargo.toml | sed -E 's/version = "([^"]+)"/\1/')"
          if [[ -z "${current_version}" ]]; then
            echo "::warning::Unable to determine current greentic-interfaces version; skipping WIT diff."
            exit 0
          fi
          if [[ "${current_version}" != "${baseline_version}" ]]; then
            echo "Detected version bump ${baseline_version} -> ${current_version}; skipping WIT diff guard."
            exit 0
          fi
          echo "Comparing staged WIT against ${baseline_tag}"
          tmpdir="$(mktemp -d)"
          current="${tmpdir}/current.wit"
          prev="${tmpdir}/prev.wit"
          wasm-tools component wit crates/greentic-interfaces/wit > "${current}"
          if ! git rev-parse -q --verify "${baseline_tag}" >/dev/null; then
            echo "Unable to resolve ${baseline_tag}; skipping WIT diff."
            exit 0
          fi
          git archive "${baseline_tag}" crates/greentic-interfaces/wit | tar -x -C "${tmpdir}"
          wasm-tools component wit "${tmpdir}/crates/greentic-interfaces/wit" > "${prev}"
          diff_file="${tmpdir}/wit.diff"
          diff -u "${prev}" "${current}" > "${diff_file}" || true
          if [[ -s "${diff_file}" ]]; then
            echo "::error::WIT contracts changed relative to ${baseline_tag}. Bump package versions or update BASELINE_TAG."
            cat "${diff_file}"
            exit 1
          fi
      - name: Show WIT package versions
        run: |
          echo "ABI workspace packages:"
          wasm-tools component wit crates/greentic-interfaces/wit | head -n 5
      - name: Build guest (default features; legacy providers off)
        run: cargo build --manifest-path crates/greentic-interfaces-guest/Cargo.toml --target wasm32-wasip2
      - name: Prune wasm artifacts to save space
        run: rm -rf target/wasm32-wasip2
      - name: Verify packageability for public WIT crates
        run: cargo package --no-verify -p greentic-interfaces -p greentic-interfaces-wasmtime
      - name: Wasmtime external consumer smoke
        run: bash ci/smoke/wasmtime_consumer.sh
      - run: cargo build --workspace --all-features
      - run: cargo test --workspace --all-features
      - name: Build describe-v1 component example
        env:
          CARGO_TARGET_DIR: target
        run: cargo build --manifest-path examples/component-describe/Cargo.toml --target wasm32-wasip2
      - name: Run runner-host smoke example
        env:
          CARGO_TARGET_DIR: target
          COMPONENT_DESCRIBE_WASM: target/wasm32-wasip2/debug/component_describe.wasm
        run: cargo run --manifest-path examples/runner-host-smoke/Cargo.toml

  windows-build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: 1.89.0
      - name: Show Rust toolchain versions
        run: |
          rustc --version
          cargo --version
      - name: Build on Windows
        run: cargo build --workspace --all-features
