name: Publish WIT (OCI)

on:
  push:
    branches: ["master"]
    tags: ["wit-v*"]
  workflow_dispatch:

jobs:
  setup-toolchain:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: 1.89.0
      - name: Install wkg
        run: cargo install wkg --locked
      - name: Install wasm-tools
        run: cargo install wasm-tools --locked
      - name: Install oras
        run: |
          set -euo pipefail
          ORAS_VERSION=1.2.0
          curl -sL "https://github.com/oras-project/oras/releases/download/v${ORAS_VERSION}/oras_${ORAS_VERSION}_linux_amd64.tar.gz" -o oras.tar.gz
          tar -xzf oras.tar.gz oras
          mkdir -p "${HOME}/.local/bin"
          install -m 755 oras "${HOME}/.local/bin/oras"
      - name: Package toolchain
        run: |
          mkdir -p toolchain/bin
          cp "${HOME}/.cargo/bin/wkg" toolchain/bin/
          cp "${HOME}/.cargo/bin/wasm-tools" toolchain/bin/
          cp "${HOME}/.local/bin/oras" toolchain/bin/
      - uses: actions/upload-artifact@v4
        with:
          name: wit-toolchain
          path: toolchain

  build-artifacts:
    runs-on: ubuntu-latest
    needs: setup-toolchain
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: wit-toolchain
          path: toolchain
      - name: Restore toolchain permissions
        run: |
          chmod +x toolchain/bin/*
          echo "${{ github.workspace }}/toolchain/bin" >> "${GITHUB_PATH}"
      - name: Build packages
        run: bash scripts/package-wit.sh target/wit-packages
      - name: Bundle greentic 1.0.0 packages
        run: bash scripts/bundle-wit.sh target/wit-packages
      - name: Stage raw package.wit assets
        run: |
          set -euo pipefail
          raw_dir="target/wit-packages/raw"
          mkdir -p "${raw_dir}"
          for pkg in component@1.0.0 host@1.0.0 lifecycle@1.0.0; do
            src="crates/greentic-interfaces/wit/greentic/${pkg}/package.wit"
            safe="${pkg//@/-}"
            cp "${src}" "${raw_dir}/${safe}-package.wit"
          done
      - name: Generate release notes snippet
        env:
          GITHUB_SERVER_URL: ${{ github.server_url }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_RUN_ID: ${{ github.run_id }}
        run: bash scripts/generate-release-notes.sh target/wit-packages/RELEASE_NOTES.md
      - uses: actions/upload-artifact@v4
        with:
          name: wit-packages
          path: target/wit-packages

  publish:
    runs-on: ubuntu-latest
    needs:
      - setup-toolchain
      - build-artifacts
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: wit-toolchain
          path: toolchain
      - name: Restore toolchain permissions
        run: |
          chmod +x toolchain/bin/*
          echo "${{ github.workspace }}/toolchain/bin" >> "${GITHUB_PATH}"
      - uses: actions/download-artifact@v4
        with:
          name: wit-packages
          path: target/wit-packages
      - name: Login GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
      - name: Publish greentic-interfaces-wit bundle
        run: |
          set -euo pipefail
          bundle="target/wit-packages/greentic-interfaces-wit-1.0.0.tar.gz"
          primary_image="ghcr.io/greentic-ai/greentic-interfaces-wit:1.0.0"
          fallback_image="ghcr.io/greentic-ai-org/greentic-interfaces-wit:1.0.0"

          if oras push "${primary_image}" \
            --artifact-type application/vnd.greentic.wit.bundle.v1+tar \
            "${bundle}:application/gzip"; then
            echo "Published bundle to ${primary_image}"
          else
            echo "Push to ${primary_image} failed, retrying with ${fallback_image}"
            oras push "${fallback_image}" \
              --artifact-type application/vnd.greentic.wit.bundle.v1+tar \
              "${bundle}:application/gzip"
            echo "Published bundle to ${fallback_image}"
          fi
      - name: Publish all
        env:
          OCI_REPO_OWNER: ${{ github.repository_owner }}
          OCI_REPO_NAME: ${{ github.event.repository.name }}
          WKG_OCI_USERNAME: ${{ github.actor }}
          WKG_OCI_PASSWORD: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          repo_root="${OCI_REPO_OWNER}/${OCI_REPO_NAME}/wit"
          echo "Using wkg: $(wkg --version)"
          for f in target/wit-packages/*.wasm; do
            file="$(basename "$f" .wasm)"
            version="${file##*-}"
            name="${file%-${version}}"
            namespace="${name%%-*}"
            package="${name#${namespace}-}"
            image="ghcr.io/${repo_root}/${namespace}/${package}:${version}"
            echo "Publishing ${image} from ${f}"
            wkg oci push "${image}" "$f"
          done
