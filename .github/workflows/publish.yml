name: Publish crates (single or workspace)

on:
  push:
    branches: [ master ]
    tags: [ "v*" ]
  workflow_dispatch:

jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: 1.88.0
          components: rustfmt,clippy
      - uses: Swatinem/rust-cache@v2
      - name: Lint & Test
        run: |
          cargo fmt --all -- --check
          cargo clippy --workspace --all-targets -- -D warnings
          cargo build --workspace --all-features
          cargo test --workspace --all-features -- --nocapture

  tag_versions:
    if: github.event_name == 'push'
    needs: build-test
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: 1.88.0
      - uses: Swatinem/rust-cache@v2
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq
      - name: Detect changed crate versions and create tags
        env:
          GIT_AUTHOR_NAME: ci-bot
          GIT_AUTHOR_EMAIL: ci-bot@users.noreply.github.com
          GIT_COMMITTER_NAME: ci-bot
          GIT_COMMITTER_EMAIL: ci-bot@users.noreply.github.com
        run: |
          set -euo pipefail
          source scripts/version-tools.sh

          mapfile -t crates < <(list_crates)
          tagged_any="false"

          if git rev-parse --verify HEAD~1 >/dev/null 2>&1; then
            diff_target="HEAD~1"
          else
            diff_target="$(git hash-object -t tree /dev/null)"
          fi

          changed_files="$(git diff --name-only "${diff_target}" HEAD)"

          for line in "${crates[@]}"; do
            name=$(awk '{print $1}' <<<"$line")
            version=$(awk '{print $2}' <<<"$line")
            manifest=$(awk '{print $3}' <<<"$line")
            tag="${name}-v${version}"

            if git rev-parse -q --verify "refs/tags/${tag}" >/dev/null; then
              echo "::notice::Tag ${tag} already exists. Skipping."
              continue
            fi

            crate_dir=$(crate_dir_from_manifest "${manifest}")
            cargo_toml="${crate_dir}/Cargo.toml"

            if ! grep -Fxq "${cargo_toml}" <<<"${changed_files}"; then
              echo "No change in ${cargo_toml} this push. Skipping ${name}."
              continue
            fi

            echo "Creating lightweight tag ${tag}"
            git tag -a "${tag}" -m "${name} ${version}"
            tagged_any="true"
          done

          if [ "${tagged_any}" = "true" ]; then
            git push --tags
          else
            echo "No new crate versions detected in this push."
          fi

  publish_crates:
    if: github.event_name == 'push'
    needs: [build-test, tag_versions]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: 1.88.0
      - uses: Swatinem/rust-cache@v2
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq
      - name: Publish crates to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          set -euo pipefail

          # Ensure publish dry-run for dependents resolves greentic-interfaces from the workspace.
          mkdir -p .cargo
          cat > .cargo/config.toml <<'EOF'
          [patch.crates-io]
          greentic-interfaces = { path = "crates/greentic-interfaces" }
          EOF

          publish_crate() {
            local manifest="$1"
            local crate="$2"
            local curl_check
            curl_check="curl -fsSL -A greentic-publish-check/1.0"

            local metadata
            metadata=$(cargo metadata --manifest-path "${manifest}" --format-version 1 --no-deps)
            local version
            version=$(jq -r '.packages[0].version' <<<"${metadata}")

            echo "::group::Processing ${crate}@${version}"

            if ${curl_check} "https://crates.io/api/v1/crates/${crate}/${version}" >/dev/null; then
              echo "${crate}@${version} already published; skipping."
              echo "::endgroup::"
              return 0
            fi

            local publish_log
            publish_log=$(mktemp)
            if cargo publish --locked --manifest-path "${manifest}" 2>&1 | tee "${publish_log}"; then
              echo "${crate}@${version} publish command succeeded."
            else
              if grep -q "already exists" "${publish_log}"; then
                echo "${crate}@${version} already existed on crates.io (publish reported already exists)."
                rm -f "${publish_log}"
                echo "::endgroup::"
                return 0
              fi
              cat "${publish_log}"
              rm -f "${publish_log}"
              echo "::endgroup::"
              return 1
            fi
            rm -f "${publish_log}"

            # Allow some propagation time after publish before checking.
            sleep 10

            for attempt in {1..30}; do
              if ${curl_check} "https://crates.io/api/v1/crates/${crate}/${version}" >/dev/null; then
                echo "${crate}@${version} now visible on crates.io."
                echo "::endgroup::"
                return 0
              fi
              echo "Waiting for ${crate}@${version} to appear (attempt ${attempt})..."
              sleep 20
            done

            if cargo publish --locked --manifest-path "${manifest}" --dry-run 2>&1 | grep -q "already exists"; then
              echo "${crate}@${version} confirmed via dry run after wait."
              echo "::endgroup::"
              return 0
            fi

            echo "${crate}@${version} not visible on crates.io after waiting." >&2
            echo "::endgroup::"
            return 1
          }

          publish_crate "crates/greentic-interfaces/Cargo.toml" "greentic-interfaces"
          publish_crate "crates/greentic-interfaces-wasmtime/Cargo.toml" "greentic-interfaces-wasmtime"
          publish_crate "crates/greentic-interfaces-host/Cargo.toml" "greentic-interfaces-host"
          publish_crate "crates/greentic-interfaces-guest/Cargo.toml" "greentic-interfaces-guest"
