name: Publish crates (single or workspace)

on:
  push:
    branches: [ master ]
    tags: [ "v*" ]
  workflow_dispatch:

jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Lint & Test
        run: |
          cargo fmt --all -- --check
          cargo clippy --workspace --all-targets -- -D warnings
          cargo build --workspace --all-features
          cargo test --workspace --all-features -- --nocapture

  publish_interfaces:
    if: github.event_name == 'push'
    needs: build-test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    outputs:
      interfaces_version: ${{ steps.metadata.outputs.version }}
      interfaces_ready: ${{ steps.ready.outputs.value }}
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Extract greentic-interfaces metadata
        id: metadata
        run: |
          set -euo pipefail
          metadata=$(cargo metadata --manifest-path crates/greentic-interfaces/Cargo.toml --format-version 1 --no-deps)
          version=$(jq -r '.packages[0].version' <<<"$metadata")
          echo "version=$version" >> "$GITHUB_OUTPUT"
      - name: Check greentic-interfaces publication status
        id: check
        run: |
          set -euo pipefail
          version="${{ steps.metadata.outputs.version }}"
          if curl -fsSL "https://crates.io/api/v1/crates/greentic-interfaces/${version}" >/dev/null; then
            echo "greentic-interfaces@${version} already published"
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi
      - name: Publish greentic-interfaces
        if: steps.check.outputs.exists != 'true'
        run: cargo publish --locked --manifest-path crates/greentic-interfaces/Cargo.toml
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
      - name: Confirm greentic-interfaces availability
        id: ready
        run: |
          set -euo pipefail
          version="${{ steps.metadata.outputs.version }}"
          already="${{ steps.check.outputs.exists }}"
          if [ "$already" = "true" ]; then
            echo "greentic-interfaces@${version} already confirmed on crates.io"
            echo "value=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          for attempt in {1..20}; do
            if curl -fsSL "https://crates.io/api/v1/crates/greentic-interfaces/${version}" >/dev/null; then
              echo "greentic-interfaces@${version} available on crates.io"
              echo "value=true" >> "$GITHUB_OUTPUT"
              exit 0
            fi
            echo "Waiting for greentic-interfaces@${version} to appear (attempt ${attempt})..."
            sleep 15
          done
          echo "greentic-interfaces@${version} not visible after waiting" >&2
          exit 1

  publish_wasmtime:
    if: github.event_name == 'push' && needs.publish_interfaces.outputs.interfaces_ready == 'true'
    needs: publish_interfaces
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Extract greentic-interfaces-wasmtime metadata
        id: metadata
        run: |
          set -euo pipefail
          metadata=$(cargo metadata --manifest-path crates/greentic-interfaces-wasmtime/Cargo.toml --format-version 1 --no-deps)
          version=$(jq -r '.packages[0].version' <<<"$metadata")
          echo "version=$version" >> "$GITHUB_OUTPUT"
      - name: Check greentic-interfaces-wasmtime publication status
        id: check
        run: |
          set -euo pipefail
          version="${{ steps.metadata.outputs.version }}"
          if curl -fsSL "https://crates.io/api/v1/crates/greentic-interfaces-wasmtime/${version}" >/dev/null; then
            echo "greentic-interfaces-wasmtime@${version} already published"
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi
      - name: Publish greentic-interfaces-wasmtime
        if: steps.check.outputs.exists != 'true'
        run: cargo publish --locked --manifest-path crates/greentic-interfaces-wasmtime/Cargo.toml
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
