name: Publish crates (single or workspace)

on:
  push:
    branches: [ master ]
    tags: [ "v*" ]
  workflow_dispatch:

jobs:
  build-test:
    permissions:
      contents: read
    runs-on: ubuntu-latest
    env:
      CARGO_TARGET_DIR: target
      CARGO_PROFILE_DEV_DEBUG: 0
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: 1.91.0
          components: rustfmt,clippy
      - name: Lint & Test
        run: |
          cargo fmt --all -- --check
          cargo clippy --workspace --all-targets -- -D warnings
          cargo build --workspace --all-features
          cargo test --workspace --all-features -- --nocapture

  build:
    runs-on: ubuntu-latest
    env:
      CARGO_TARGET_DIR: target
      CARGO_PROFILE_DEV_DEBUG: 0
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: 1.91.0
          components: rustfmt,clippy
          targets: wasm32-wasip2
      - name: Install ripgrep
        run: sudo apt-get update && sudo apt-get install -y ripgrep
      - name: Install WIT tooling
        run: cargo install wasm-tools --locked
      - name: Check for duplicate canonical WIT
        run: bash ci/check_no_duplicate_canonical_wit.sh .
      - name: Show toolchain versions
        run: |
          wasm-tools --version
          cargo --version
          rustc --version
      - name: Install wasm32-wasip2 target
        run: rustup target add wasm32-wasip2
      - run: cargo fmt --all -- --check
      - run: cargo clippy --workspace --all-features -- -D warnings
      - name: Validate ABI WIT packages
        run: bash scripts/validate-wit.sh crates/greentic-interfaces/wit
      - name: Ensure SPDX headers present
        run: |
          set -euo pipefail
          missing=$(rg --files -g 'package.wit' crates/greentic-interfaces/wit | while read -r file; do
            if [[ "$(head -n1 "$file")" != "// SPDX-License-Identifier: MIT" ]]; then
              echo "$file"
            fi
          done)
          if [[ -n "${missing}" ]]; then
            echo "::error::Missing SPDX header in the following WIT files:"
            echo "${missing}"
            exit 1
          fi
      - name: Guard WIT API against latest tag
        run: |
          set -euo pipefail
          latest_tag="$(git tag --list 'v*' --sort=-version:refname | head -n1 | tr -d '\n')"
          baseline_tag="${BASELINE_TAG:-${latest_tag}}"
          if [[ -z "${baseline_tag}" ]]; then
            echo "No baseline release tag found; skipping WIT diff."
            exit 0
          fi
          baseline_version="${baseline_tag#v}"
          current_version="$(grep -m1 '^version = ' crates/greentic-interfaces/Cargo.toml | sed -E 's/version = "([^"]+)"/\1/')"
          if [[ -z "${current_version}" ]]; then
            echo "::warning::Unable to determine current greentic-interfaces version; skipping WIT diff."
            exit 0
          fi
          if [[ "${current_version}" != "${baseline_version}" ]]; then
            echo "Detected version bump ${baseline_version} -> ${current_version}; skipping WIT diff guard."
            exit 0
          fi
          echo "Comparing staged WIT against ${baseline_tag}"
          tmpdir="$(mktemp -d)"
          current="${tmpdir}/current.wit"
          prev="${tmpdir}/prev.wit"
          wasm-tools component wit crates/greentic-interfaces/wit > "${current}"
          if ! git rev-parse -q --verify "${baseline_tag}" >/dev/null; then
            echo "Unable to resolve ${baseline_tag}; skipping WIT diff."
            exit 0
          fi
          git archive "${baseline_tag}" crates/greentic-interfaces/wit | tar -x -C "${tmpdir}"
          wasm-tools component wit "${tmpdir}/crates/greentic-interfaces/wit" > "${prev}"
          diff_file="${tmpdir}/wit.diff"
          diff -u "${prev}" "${current}" > "${diff_file}" || true
          if [[ -s "${diff_file}" ]]; then
            echo "::error::WIT contracts changed relative to ${baseline_tag}. Bump package versions or update BASELINE_TAG."
            cat "${diff_file}"
            exit 1
          fi
      - name: Show WIT package versions
        run: |
          echo "ABI workspace packages:"
          wasm-tools component wit crates/greentic-interfaces/wit | head -n 5
      - name: Build guest (default features; legacy providers off)
        run: cargo build --manifest-path crates/greentic-interfaces-guest/Cargo.toml --target wasm32-wasip2
      - name: Prune wasm artifacts to save space
        run: rm -rf target/wasm32-wasip2
      - name: Verify packageability for public WIT crates
        run: cargo package --no-verify -p greentic-interfaces -p greentic-interfaces-wasmtime
      - name: Wasmtime external consumer smoke
        run: bash ci/smoke/wasmtime_consumer.sh
      - run: cargo build --workspace --all-features
      - run: cargo test --workspace --all-features
      - name: Packaged external consumer check (greentic-interfaces)
        run: bash ci/steps/external_consumer_check.sh
      - name: Build describe-v1 component example
        env:
          CARGO_TARGET_DIR: target
        run: cargo build --manifest-path examples/component-describe/Cargo.toml --target wasm32-wasip2
      - name: Run runner-host smoke example
        env:
          CARGO_TARGET_DIR: target
          COMPONENT_DESCRIBE_WASM: target/wasm32-wasip2/debug/component_describe.wasm
        run: cargo run --manifest-path examples/runner-host-smoke/Cargo.toml

  windows-build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: 1.91.0
      - name: Show Rust toolchain versions
        run: |
          rustc --version
          cargo --version
      - name: Build on Windows
        run: cargo build --workspace --all-features

  tag_versions:
    if: github.event_name == 'push'
    needs: [build-test, build, windows-build]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: 1.91.0
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq
      - name: Detect changed crate versions and create tags
        env:
          GIT_AUTHOR_NAME: ci-bot
          GIT_AUTHOR_EMAIL: ci-bot@users.noreply.github.com
          GIT_COMMITTER_NAME: ci-bot
          GIT_COMMITTER_EMAIL: ci-bot@users.noreply.github.com
        run: |
          set -euo pipefail
          source scripts/version-tools.sh

          mapfile -t crates < <(list_crates)
          tagged_any="false"

          if git rev-parse --verify HEAD~1 >/dev/null 2>&1; then
            diff_target="HEAD~1"
          else
            diff_target="$(git hash-object -t tree /dev/null)"
          fi

          changed_files="$(git diff --name-only "${diff_target}" HEAD)"

          for line in "${crates[@]}"; do
            name=$(awk '{print $1}' <<<"$line")
            version=$(awk '{print $2}' <<<"$line")
            manifest=$(awk '{print $3}' <<<"$line")
            tag="${name}-v${version}"

            if git rev-parse -q --verify "refs/tags/${tag}" >/dev/null; then
              echo "::notice::Tag ${tag} already exists. Skipping."
              continue
            fi

            crate_dir=$(crate_dir_from_manifest "${manifest}")
            cargo_toml="${crate_dir}/Cargo.toml"

            if ! grep -Fxq "${cargo_toml}" <<<"${changed_files}"; then
              echo "No change in ${cargo_toml} this push. Skipping ${name}."
              continue
            fi

            echo "Creating lightweight tag ${tag}"
            git tag -a "${tag}" -m "${name} ${version}"
            tagged_any="true"
          done

          if [ "${tagged_any}" = "true" ]; then
            git push --tags
          else
            echo "No new crate versions detected in this push."
          fi

  publish_crates:
    if: github.event_name == 'push'
    needs: [build-test, tag_versions]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    env:
      CARGO_TARGET_DIR: target
      CARGO_PROFILE_DEV_DEBUG: 0
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: 1.91.0
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq
      - name: Publish crates to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          set -euo pipefail

          # Ensure publish dry-run for dependents resolves greentic-interfaces from the workspace.
          mkdir -p .cargo
          cat > .cargo/config.toml <<'EOF'
          [patch.crates-io]
          greentic-interfaces = { path = "crates/greentic-interfaces" }
          EOF

          # Refresh lockfile to reflect the patched source before --locked publishes.
          pkg_version="$(cargo metadata --manifest-path crates/greentic-interfaces/Cargo.toml --format-version 1 --no-deps | jq -r '.packages[0].version')"
          pkgid="path+file://${GITHUB_WORKSPACE}/crates/greentic-interfaces#${pkg_version}"
          cargo update -p "${pkgid}" --workspace

          publish_crate() {
            local manifest="$1"
            local crate="$2"
            local curl_check
            curl_check="curl -fsSL -A greentic-publish-check/1.0"

            local metadata
            metadata=$(cargo metadata --manifest-path "${manifest}" --format-version 1 --no-deps)
            local version
            version=$(jq -r '.packages[0].version' <<<"${metadata}")

            echo "::group::Processing ${crate}@${version}"

            if ${curl_check} "https://crates.io/api/v1/crates/${crate}/${version}" >/dev/null; then
              echo "${crate}@${version} already published; skipping."
              echo "::endgroup::"
              return 0
            fi

            local publish_log
            publish_log=$(mktemp)
            if cargo publish --locked --manifest-path "${manifest}" 2>&1 | tee "${publish_log}"; then
              echo "${crate}@${version} publish command succeeded."
            else
              if grep -q "already exists" "${publish_log}"; then
                echo "${crate}@${version} already existed on crates.io (publish reported already exists)."
                rm -f "${publish_log}"
                echo "::endgroup::"
                return 0
              fi
              cat "${publish_log}"
              rm -f "${publish_log}"
              echo "::endgroup::"
              return 1
            fi
            rm -f "${publish_log}"

            # Allow some propagation time after publish before checking.
            sleep 10

            for attempt in {1..30}; do
              if ${curl_check} "https://crates.io/api/v1/crates/${crate}/${version}" >/dev/null; then
                echo "${crate}@${version} now visible on crates.io."
                echo "::endgroup::"
                return 0
              fi
              echo "Waiting for ${crate}@${version} to appear (attempt ${attempt})..."
              sleep 20
            done

            if cargo publish --locked --manifest-path "${manifest}" --dry-run 2>&1 | grep -q "already exists"; then
              echo "${crate}@${version} confirmed via dry run after wait."
              echo "::endgroup::"
              return 0
            fi

            echo "${crate}@${version} not visible on crates.io after waiting." >&2
            echo "::endgroup::"
            return 1
          }

          publish_crate "crates/greentic-interfaces/Cargo.toml" "greentic-interfaces"
          publish_crate "crates/greentic-interfaces-wasmtime/Cargo.toml" "greentic-interfaces-wasmtime"
          publish_crate "crates/greentic-interfaces-host/Cargo.toml" "greentic-interfaces-host"
          publish_crate "crates/greentic-interfaces-guest/Cargo.toml" "greentic-interfaces-guest"
