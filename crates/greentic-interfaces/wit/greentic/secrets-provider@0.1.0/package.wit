// SPDX-License-Identifier: MIT
// DEPRECATED: Legacy secrets provider protocol (frozen). New providers must use greentic:provider-schema-core@1.0.0.

package greentic:secrets-provider@0.1.0;

/// Shared types for secret provider components.
interface types {
  /// Generic metadata key/value pair.
  type kv = tuple<string, string>;

  /// Correlation metadata propagated by the host runtime.
  record correlation {
    correlation-id: option<string>,
    request-id: option<string>,
    trace-id: option<string>,
    span-id: option<string>,
    attributes: list<kv>,
  }

  /// Health/permission check outcome.
  enum check-status { passed, warning, failed }

  /// Individual issue surfaced by a check.
  record check-issue {
    code: string,
    message: string,
    retriable: bool,
    details: list<kv>,
  }

  /// Aggregated check report.
  record check-report {
    status: check-status,
    issues: list<check-issue>,
  }

  /// Classification for provider errors.
  enum error-kind {
    invalid-config,
    unauthenticated,
    unauthorized,
    not-found,
    conflict,
    throttled,
    unavailable,
    unsupported,
    internal,
  }

  /// Canonical provider error payload.
  record error {
    kind: error-kind,
    message: string,
    retriable: bool,
    detail-code: option<string>,
  }

  /// Reference to a provider-managed secret.
  record secret-ref {
    /// Provider-specific key/name/path.
    key: string,
    /// Optional namespace/mount/scope.
    scope: option<string>,
    /// Optional labels used by providers that key on tags.
    labels: list<kv>,
  }

  /// Provider capability flags.
  record capabilities {
    supports-versioning: bool,
    supports-tags: bool,
    supports-atomic-promote: bool,
    supports-ttl: bool,
    max-value-bytes: option<u32>,
  }

  /// Input for writes or rotations.
  record write-input {
    secret: secret-ref,
    value: list<u8>,
    content-type: option<string>,
    tags: list<kv>,
    ttl-seconds: option<u64>,
  }

  /// Input for atomic promotion.
  record promote-input {
    secret: secret-ref,
    version: string,
    expected-current: option<string>,
  }

  /// Receipt returned after writes or promotions.
  record receipt {
    secret: secret-ref,
    version: string,
    tags: list<kv>,
  }

  /// Secret payload read from the provider.
  record read-result {
    secret: secret-ref,
    version: option<string>,
    value: list<u8>,
    content-type: option<string>,
    tags: list<kv>,
    expires-ms: option<u64>,
  }

  /// Version metadata surfaced by list-versions.
  record secret-version {
    version: string,
    created-ms: option<u64>,
    updated-ms: option<u64>,
    expires-ms: option<u64>,
    tags: list<kv>,
  }

  /// Version listing response.
  record versions-result {
    secret: secret-ref,
    versions: list<secret-version>,
  }

  /// Standard result wrapper for check operations.
  type check-result = result<check-report, error>;
  /// Standard result wrapper for capability discovery.
  type capabilities-result = result<capabilities, error>;
  /// Standard result wrapper for reads.
  type read-outcome = result<read-result, error>;
  /// Standard result wrapper for write/promotion receipts.
  type receipt-result = result<receipt, error>;
  /// Standard result wrapper for version listings.
  type versions-outcome = result<versions-result, error>;
}

/// Provider operations implemented by cloud/KV-specific components.
interface provider-api {
  use types.{
    capabilities,
    capabilities-result,
    check-report,
    check-result,
    correlation,
    promote-input,
    read-outcome,
    receipt-result,
    secret-ref,
    versions-outcome,
    write-input,
  };

  /// Validates connectivity with the backend using the supplied config JSON.
  connect-test: func(config-json: string, ctx: correlation) -> check-result;

  /// Validates permissions for read/write/metadata operations.
  permissions-test: func(config-json: string, ctx: correlation) -> check-result;

  /// Returns supported feature flags and limits.
  get-capabilities: func(config-json: string, ctx: correlation) -> capabilities-result;

  /// Reads the current or specific version of a secret.
  get-secret: func(
    config-json: string,
    secret: secret-ref,
    version: option<string>,
    ctx: correlation
  ) -> read-outcome;

  /// Writes or rotates a secret value.
  put-secret: func(config-json: string, input: write-input, ctx: correlation) -> receipt-result;

  /// Promotes an existing version to current (optionally atomically).
  promote-version: func(config-json: string, input: promote-input, ctx: correlation) -> receipt-result;

  /// Lists known versions for a secret.
  list-versions: func(config-json: string, secret: secret-ref, ctx: correlation) -> versions-outcome;
}

world provider {
  export provider-api;
}
